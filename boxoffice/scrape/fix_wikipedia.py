slug_fixes = {
    "Sing_(2016_American_film)": "Sing_(2016_film)",
    "The_Visit_(2015_Nigerian_film)": "The_Visit_(2015_film)",
    "Joy_(2015_film)": "Joy_(film)",
    "The_Forest_(2016_American_film)": "The_Forest_(2016_film)",
    "Alice_Through_the_Looking_Glass_(2016_film)": "Alice_Through_the_Looking_Glass_(film)",
    # "Hillary's_America:_The_Secret_History_of_the_Democratic_Party": "Hillary's_America:_The_Secret_History_of_the_Democratic_Party", # this seemed to not have existed before the movie came out,
    "Kevin_Hart:_What_Now?": "Kevin_Hart:_What_Now%3F",
    "Office_Christmas_Party": "Office_Christmas_Party_(film)",
    "Why_Him?": "Why_Him%3F",
    "Wind_River_(2017_film)": "Wind_River_(film)",
    "Battle_of_the_Sexes_(2017_film)": "Battle_of_the_Sexes_(film)",
    "Just_Getting_Started_(2017_film)": "Just_Getting_Started_(film)",
    "Traffik_(2018_film)": "Traffik_(film)",
    "Alpha_(2018_film)": "Alpha_(film)",
    "Fahrenheit_11/9": "Fahrenheit_11%2F9",
    "Escape_Room_(2019_film)": "Escape_Room_(film)",
    "Upside-Down_Magic_(2020_film)": "Upside-Down_Magic_(film)",
    "Anna_(2019_feature_film)": "Anna_(2019_film)",
    "Demon_Slayer:_Kimetsu_no_Yaiba_–_The_Movie:_Mugen_Train": "Demon_Slayer:_Kimetsu_no_Yaiba_the_Movie:_Mugen_Train",
    "Paw_Patrol:_The_Movie": "PAW_Patrol:_The_Movie",
    "Ambulance_(2022_film)": "Ambulance_(film)",
    "Are_You_There_God?_It's_Me,_Margaret._(film)": "Are_You_There_God%3F_It's_Me,_Margaret._(film)",
    "Paw_Patrol:_The_Mighty_Movie": "PAW_Patrol:_The_Mighty_Movie",
    # "Journey_to_Bethlehem": "Journey_to_Bethlehem_(film)",
    "Tarot_(2024_South_Korean_film)": "Tarot_(2024_film)",
}

# use this link for page moves: https://en.wikipedia.org/w/index.php?title=The_33&action=history&offset=&limit=500

slugs_additive = {
    # "Sing_(2016_American_film)": "Sing_(2016_film)",
    # "Joy_(2015_film)": "Joy_(film)",
    # "Frozen_2": "Frozen_II",
    # "The_Transporter_Refueled": "The_Transporter:_Refueled",
    # "Love_the_Coopers": "Let_It_Snow_(2016_film)",
    # "The_33": "The_33_(film)",
    # "Ride_Along_(film)": "Ride_Along",
    # "Norm_of_the_North": "Norm_of_the_North_(film)",
    # "Zoolander_2": "Zoolander_No._2",
    # "How_to_Be_Single": "How_to_Be_Single_(film)",
    # "Eye_in_the_Sky_(2015_film)": "Eye_in_the_Sky_(film)",
    # "The_Young_Messiah": "The_Young_Messiah_(film)",
    # "God's_Not_Dead_2": "God's_Not_Dead_2_(film)",
    # "Meet_the_Blacks": "Meet_the_Blacks_(film)",
    # "Barbershop:_The_Next_Cut": "Barbershop_3",
    # "Teenage_Mutant_Ninja_Turtles:_Out_of_the_Shadows": "Teenage_Mutant_Ninja_Turtles:_Out_of_the_Shadows_(film)",
    # "Suicide_Squad_(2016_film)": "Suicide_Squad_(film)",
    # "Nine_Lives_(2016_film)": "Nine_Lives_(film)",
    # "Hell_or_High_Water_(film)": "Hell_or_High_Water_(2016_film)",
    # "Snowden_(film)": "Snowden_(2016_film)",
    # "Woodlawn_(film)": "Woodlawn_(film)",
    # "Hillary's_America:_The_Secret_History_of_the_Democratic_Party": "Hillary's_America:_The_Secret_History_of_the_Democratic_Party_(film)",
    # "Don't_Breathe": "Don't_Breathe_(film)",
    # "Middle_School:_The_Worst_Years_of_My_Life_(film)": "Middle_School:_The_Worst_Years_of_My_Life",
    # "Kevin_Hart:_What_Now?": "Kevin_Hart:_What_Now",
    # "Boo!_A_Madea_Halloween": "Boo!_A_Madea_Halloween_(film)",
    # "Moonlight_(2016_film)": "Moonlight_(film)",
    # "Doctor_Strange_(2016_film)": "Doctor_Strange_(film)",
    # "Almost_Christmas_(film)": "Almost_Christmas",
    # "Shut_In_(2016_film)": "Shut_In_(film)",
    # "Nocturnal_Animals": "Nocturnal_Animals_(film)",
    # "Manchester_by_the_Sea_(film)": "Manchester_by_the_Sea",
    # "Bad_Santa_2": "Bad_Santa_2_(film)",
    # "Incarnate_(film)": "Incarnate_(2016_film)",
    # "0": "Zero_(film)",  # Possible incorrect entry? Needs clarification.
    # "La_La_Land": "La_La_Land_(film)",
    # "Sleepless_(2017_film)": "Sleepless_(film)",
    # "The_Founder": "The_Founder_(film)",
    # "Get_Out": "Get_Out_(film)",
    # "Rock_Dog": "Rock_Dog_(film)",
    # "The_Zookeeper's_Wife_(film)": "The_Zookeeper's_Wife",
    # "The_Case_for_Christ": "The_Case_for_Christ_(film)",
    # "Gifted_(2017_film)": "Gifted_(film)",
    # "The_Promise_(2017_film)": "The_Promise_(film)",
    # "Pure_Love_(film)": "Pure_Love_(2017_film)",
    # "How_to_Be_a_Latin_Lover": "How_to_Be_a_Latin_Lover_(film)",
    # "Girls_Trip": "Girls_Trip_(film)",
    # "Wind_River_(film)": "Wind_River",
    # "The_Nut_Job_2:_Nutty_by_Nature": "The_Nut_Job_2:_Nutty_by_Nature_(film)",
    # "Ballerina_(2016_film)": "Ballerina_(film)",
    # "Same_Kind_of_Different_as_Me_(film)": "Same_Kind_of_Different_as_Me",
    # "Boo_2!_A_Madea_Halloween": "Boo_2!_A_Madea_Halloween_(film)",
    # "A_Bad_Moms_Christmas": "A_Bad_Moms_Christmas_(film)",
    # "Lady_Bird_(film)": "Lady_Bird",
    # "Darkest_Hour_(film)": "Darkest_Hour",
    # "The_Shape_of_Water": "The_Shape_of_Water_(film)",
    # "Just_Getting_Started_(2017_film)": "Just_Getting_Started",
    # "Downsizing_(film)": "Downsizing_(2017_film)",
    # "Father_Figures": "Father_Figures_(film)",
    # "Hostiles_(film)": "Hostiles_(2017_film)",
    # "Proud_Mary_(film)": "Proud_Mary",
    # "Forever_My_Girl": "Forever_My_Girl_(film)",
    # "The_Hurricane_Heist": "The_Hurricane_Heist_(film)",
    # "Tomb_Raider_(film)": "Tomb_Raider_(2018_film)",
    # "Paul,_Apostle_of_Christ": "Paul,_Apostle_of_Christ_(film)",
    # "Unsane": "Unsane_(film)",
    # "A_Quiet_Place": "A_Quiet_Place_(film)",
    # "Traffik_(film)": "Traffik_(2018_film)",
    # "Life_of_the_Party_(2018_film)": "Life_of_the_Party",
    # "Breaking_In_(2018_film)": "Breaking_In",
    # "Show_Dogs": "Show_Dogs_(film)",
    # "Book_Club_(film)": "Book_Club",
    # "Upgrade_(film)": "Upgrade_(2018_film)",
    # "Superfly_(2018_film)": "Superfly_(2018_film)",
    # "Uncle_Drew": "Uncle_Drew_(film)",
    # "Sorry_to_Bother_You": "Sorry_to_Bother_You_(film)",
    # "Eighth_Grade_(film)": "Eighth_Grade",
    # "The_Darkest_Minds": "The_Darkest_Minds_(film)",
    # "Dog_Days_(2018_film)": "Dog_Days_(2018_film)",
    # "Alpha_(2018_film)": "Alpha_(film)",
    # "A.X.L.": "A.X.L._(film)",
    # "Kin_(film)": "Kin_(2018_film)",
    # "Fahrenheit_11/9": "Fahrenheit_11/9_(film)",
    # "Hell_Fest": "Hell_Fest_(film)",
    # "Nobody's_Fool_(2018_film)": "Nobody's_Fool_(film)",
    # "The_Favourite": "The_Favourite_(film)",
    # "Upside-Down_Magic_(film)": "Upside-Down_Magic",
    # "Miss_Bala_(2019_film)": "Miss_Bala_(film)",
    # "What_Men_Want": "What_Men_Want_(film)",
    # "The_Prodigy_(film)": "The_Prodigy_(2019_film)",
    # "A_Madea_Family_Funeral": "A_Madea_Family_Funeral_(film)",
    # "Captive_State": "Captive_State_(film)",
    # "Unplanned": "Unplanned_(film)",
    # "The_Intruder_(2019_film)": "The_Intruder_(film)",
    # "UglyDolls": "UglyDolls_(film)",
    # "Poms_(film)": "Poms_(2019_film)",
    # "Detective_Pikachu_(film)": "Detective_Pikachu_(2019_film)",
    # "Booksmart": "Booksmart_(film)",
    # "Ma_(2019_film)": "Ma_(film)",
    # "Late_Night_(film)": "Late_Night_(2019_film)",
    # "Midsommar": "Midsommar_(film)",
    # "The_Peanut_Butter_Falcon": "The_Peanut_Butter_Falcon_(film)",
    # "Where'd_You_Go,_Bernadette_(film)": "Where'd_You_Go,_Bernadette_(2019_film)",
    # "Overcomer_(film)": "Overcomer_(2019_film)",
    # "Hustlers_(film)": "Hustlers_(2019_film)",
    # "Jexi": "Jexi_(film)",
    # "Black_and_Blue_(2019_film)": "Black_and_Blue_(film)",
    # "Countdown_(2019_film)": "Countdown_(film)",
    # "Harriet_(film)": "Harriet_(2019_film)",
    # "Motherless_Brooklyn": "Motherless_Brooklyn_(film)",
    # "Arctic_Dogs": "Arctic_Dogs_(film)",
    #  "Knives_Out": "Knives_Out_(film)",
    # "The_Grudge_(2019_film)": "The_Grudge_(film)",
    # "Like_a_Boss_(film)": "Like_a_Boss",
    # "The_Way_Back_(2020_film)": "The_Way_Back",
    # "The_Photograph_(2020_film)": "The_Photograph",
    # "Impractical_Jokers:_The_Movie": "Impractical_Jokers:_The_Movie_(film)",
    # "Emma_(2020_film)": "Emma_(film)",
    # "Come_Play": "Come_Play_(film)",
    # "The_Marksman_(2021_film)": "The_Marksman",
    # "Encanto": "Encanto_(film)",
    # "Blacklight_(film)": "Blacklight_(2022_film)",
    # "His_Only_Son": "His_Only_Son_(film)",
    # "Big_George_Foreman": "Big_George_Foreman_(film)",
    # "Are_You_There_God?_It's_Me,_Margaret._(film)": "Are_You_There_God?_It's_Me,_Margaret",
    # "Teenage_Mutant_Ninja_Turtles:_Mutant_Mayhem_(soundtrack)": "Teenage_Mutant_Ninja_Turtles:_Mutant_Mayhem",
    # "Journey_to_Bethlehem": "Journey_to_Bethlehem_(film)",
    # "Cabrini_(film)": "Cabrini_(2020_film)",
    # "Unsung_Hero_(film)": "Unsung_Hero_(2020_film)",
    # "Horizon:_An_American_Saga_–_Chapter_1": "Horizon:_An_American_Saga_–_Chapter_1_(film)",
    # "Sound_of_Hope:_The_Story_of_Possum_Trot": "Sound_of_Hope:_The_Story_of_Possum_Trot_(film)"
}

slugs_replace = {
    "Star_Wars_(film)": "Star_Wars:_The_Last_Jedi",
}


"""
The_Transporter_Refueled
Woodlawn_(film)
Love_the_Coopers
The_33
Ride_Along_(film)
Norm_of_the_North
Zoolander_2
How_to_Be_Single
Eye_in_the_Sky_(2015_film)
The_Young_Messiah
God's_Not_Dead_2
Meet_the_Blacks
Barbershop:_The_Next_Cut
Teenage_Mutant_Ninja_Turtles:_Out_of_the_Shadows
Hillary's_America:_The_Secret_History_of_the_Democratic_Party
Suicide_Squad_(2016_film)
Nine_Lives_(2016_film)
Hell_or_High_Water_(film)
Don't_Breathe
Snowden_(film)
Middle_School:_The_Worst_Years_of_My_Life_(film)
Kevin_Hart:_What_Now?
Boo!_A_Madea_Halloween
Moonlight_(2016_film)
Doctor_Strange_(2016_film)
Almost_Christmas_(film)
Shut_In_(2016_film)
Nocturnal_Animals
Manchester_by_the_Sea_(film)
Bad_Santa_2
Incarnate_(film)
0
La_La_Land
Sleepless_(2017_film)
The_Founder
Get_Out
Rock_Dog
The_Zookeeper's_Wife_(film)
The_Case_for_Christ
Gifted_(2017_film)
The_Promise_(2017_film)
Pure_Love_(film)
How_to_Be_a_Latin_Lover
Girls_Trip
Wind_River_(film)
The_Nut_Job_2:_Nutty_by_Nature
Ballerina_(2016_film)
Same_Kind_of_Different_as_Me_(film)
Boo_2!_A_Madea_Halloween
A_Bad_Moms_Christmas
Lady_Bird_(film)
Darkest_Hour_(film)
The_Shape_of_Water
Just_Getting_Started_(2017_film)
Downsizing_(film)
Father_Figures
Hostiles_(film)
Proud_Mary_(film)
Forever_My_Girl
The_Hurricane_Heist
Tomb_Raider_(film)
Paul,_Apostle_of_Christ
Unsane
A_Quiet_Place
Traffik_(film)
Life_of_the_Party_(2018_film)
Breaking_In_(2018_film)
Show_Dogs
Book_Club_(film)
Upgrade_(film)
Superfly_(2018_film)
Uncle_Drew
Sorry_to_Bother_You
Eighth_Grade_(film)
The_Darkest_Minds
Dog_Days_(2018_film)
Alpha_(2018_film)
A.X.L.
Kin_(film)
Fahrenheit_11/9
Hell_Fest
Nobody's_Fool_(2018_film)
The_Favourite
Upside-Down_Magic_(film)
Miss_Bala_(2019_film)
What_Men_Want
The_Prodigy_(film)
A_Madea_Family_Funeral
Captive_State
Unplanned
The_Intruder_(2019_film)
UglyDolls
Poms_(film)
Detective_Pikachu_(film)
Booksmart
Ma_(2019_film)
Late_Night_(film)
Midsommar
The_Peanut_Butter_Falcon
Where'd_You_Go,_Bernadette_(film)
Overcomer_(film)
Hustlers_(film)
Jexi
Black_and_Blue_(2019_film)
Countdown_(2019_film)
Harriet_(film)
Motherless_Brooklyn
Arctic_Dogs
Knives_Out
The_Grudge_(2019_film)
Like_a_Boss_(film)
The_Way_Back_(2020_film)
The_Photograph_(2020_film)
Impractical_Jokers:_The_Movie
Emma_(2020_film)
Come_Play
The_Marksman_(2021_film)
Encanto
Blacklight_(film)
His_Only_Son
Big_George_Foreman
Are_You_There_God?_It's_Me,_Margaret._(film)
Teenage_Mutant_Ninja_Turtles:_Mutant_Mayhem_(soundtrack)
Journey_to_Bethlehem
Cabrini_(film)
Unsung_Hero_(film)
Horizon:_An_American_Saga_–_Chapter_1
Sound_of_Hope:_The_Story_of_Possum_Trot
"""

import datetime
from boxoffice.db.db import Movie, WikipediaDay
from boxoffice.scrape.wikipedia_page_views import (
    get_start_date_end_date,
    create_wikipedia_items,
    get_wikipedia_url,
    request_wikipedia_page_views,
)
import peewee

if __name__ == "__main__":
    for movie in Movie.select():
        if movie.wikipedia_key in slug_fixes:
            start_date, end_date = get_start_date_end_date(movie)

            wikipedia_key = slug_fixes[movie.wikipedia_key]
            url = get_wikipedia_url(wikipedia_key, start_date, end_date)

            items = request_wikipedia_page_views(url, movie.title)

            if items is None:
                print(f"no items for {movie.title}")
                continue
            try:
                wikipedia_days = create_wikipedia_items(movie, items)
            except peewee.IntegrityError:
                print(f"already have wikipedia days for {movie.title}")
                continue

    print("done with slug fixes")
    for movie in Movie.select():
        if movie.wikipedia_key in slugs_additive:
            start_date, end_date = get_start_date_end_date(movie)

            wikipedia_key = slugs_additive[movie.wikipedia_key]
            url = get_wikipedia_url(wikipedia_key, start_date, end_date)

            items = request_wikipedia_page_views(url, movie.title)

            if items is None:
                print(f"no items for {movie.title}")
                continue

            for item in items:
                date = datetime.datetime.strptime(item["timestamp"], "%Y%m%d00")
                date = datetime.date(date.year, date.month, date.day)
                views = item["views"]

                existing_day = WikipediaDay.select().where(WikipediaDay.date == date, WikipediaDay.movie == movie)

                # update the existing by adding the new views
                if existing_day.count() > 0:
                    existing_day = existing_day.get()
                    existing_day.views += views
                    existing_day.save()
                    print(f"updated {movie.title} on {date} with {views} views")
                else:
                    wikipedia_day = WikipediaDay.create(
                        date=date,
                        views=views,
                        movie=movie,
                    )

                    wikipedia_day.save()

    print("done with additive fixes")

    for movie in Movie.select():
        if movie.wikipedia_key in slugs_replace:
            start_date, end_date = get_start_date_end_date(movie)

            wikipedia_key = slugs_replace[movie.wikipedia_key]

            # update the actual movie
            movie.wikipedia_key = wikipedia_key
            movie.save()

            # delete the existing wikipedia days
            WikipediaDay.delete().where(WikipediaDay.movie == movie).execute()

            url = get_wikipedia_url(wikipedia_key, start_date, end_date)

            items = request_wikipedia_page_views(url, movie.title)

            if items is None:
                print(f"no items for {movie.title}")
                continue
            try:
                wikipedia_days = create_wikipedia_items(movie, items)
            except peewee.IntegrityError:
                print(f"already have wikipedia days for {movie.title}")
                continue
